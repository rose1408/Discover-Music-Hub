<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DMS Admin Configuration Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .admin-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      max-width: 1400px;
      margin: 0 auto;
      animation: slideIn 0.8s ease-out;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .admin-header {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      padding: 25px;
      text-align: center;
      position: relative;
    }
    
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 10px 15px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .admin-header h1 {
      font-size: 2.2rem;
      font-weight: 300;
      margin-bottom: 8px;
    }
    
    .admin-header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }
    
    .admin-tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      overflow-x: auto;
      padding: 0 20px;
    }
    
    .tab-btn {
      background: transparent;
      border: none;
      padding: 15px 25px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #6c757d;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      white-space: nowrap;
    }
    
    .tab-btn:hover {
      color: #2c3e50;
      background: rgba(44, 62, 80, 0.05);
    }
    
    .tab-btn.active {
      color: #2c3e50;
      border-bottom-color: #2c3e50;
      background: white;
    }
    
    .admin-content {
      padding: 25px;
      min-height: 600px;
    }
    
    .config-section {
      display: none;
      animation: fadeIn 0.4s ease;
    }
    
    .config-section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .config-group {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #3498db;
    }
    
    .config-group h3 {
      font-size: 1.3rem;
      color: #2c3e50;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .config-row {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
    }
    
    .config-label {
      font-weight: 600;
      color: #495057;
      font-size: 0.95rem;
    }
    
    .config-input {
      padding: 10px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: white;
    }
    
    .config-input:focus {
      outline: none;
      border-color: #2c3e50;
      box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
    }
    
    .config-textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }
    
    .config-select {
      background: white;
      cursor: pointer;
    }
    
    .tag-input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      background: white;
      min-height: 45px;
    }
    
    .tag {
      background: #3498db;
      color: white;
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .tag-remove {
      background: rgba(255, 255, 255, 0.3);
      border: none;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .tag-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 0.95rem;
      min-width: 150px;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 30px 0;
      flex-wrap: wrap;
    }
    
    .action-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn-save {
      background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
      color: white;
    }
    
    .btn-save:hover {
      background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
    }
    
    .btn-export {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
    }
    
    .btn-export:hover {
      background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
      transform: translateY(-2px);
    }
    
    .btn-validate {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
    }
    
    .btn-validate:hover {
      background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
      transform: translateY(-2px);
    }
    
    .btn-reset {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }
    
    .btn-reset:hover {
      background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
      transform: translateY(-2px);
    }
    
    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 600;
      text-align: center;
      display: none;
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .config-description {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 5px;
      font-style: italic;
    }
    
    .preview-section {
      background: #ffffff;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .preview-section h4 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }
    
    .color-preview {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    @media (max-width: 768px) {
      .config-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .admin-tabs {
        padding: 0 10px;
      }
      
      .tab-btn {
        padding: 12px 15px;
        font-size: 0.9rem;
      }
      
      .admin-content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <button class="back-btn" onclick="goToPage('index.html')">‚Üê Back to Dashboard</button>
      <h1>‚öôÔ∏è Admin Configuration Panel</h1>
      <p>Customize your Discover Music School system settings</p>
    </div>

    <div class="admin-tabs">
      <button class="tab-btn active" onclick="showSection('school')">üè´ School Info</button>
      <button class="tab-btn" onclick="showSection('business')">üíº Business Rules</button>
      <button class="tab-btn" onclick="showSection('options')">üìù Options & Lists</button>
      <button class="tab-btn" onclick="showSection('interface')">üé® Interface & Theme</button>
      <button class="tab-btn" onclick="showSection('features')">‚ö° Features & Settings</button>
      <button class="tab-btn" onclick="showSection('notifications')">üìß Notifications</button>
      <button class="tab-btn" onclick="showSection('advanced')">üîß Advanced</button>
    </div>

    <div class="admin-content">
      <!-- Status Messages -->
      <div id="statusMessage" class="status-message"></div>

      <!-- School Information Section -->
      <div id="school" class="config-section active">
        <div class="config-group">
          <h3>üè´ School Information</h3>
          <div class="config-row">
            <div class="config-label">School Name</div>
            <input type="text" id="schoolName" class="config-input" placeholder="Discover Music School">
          </div>
          <div class="config-row">
            <div class="config-label">School Email</div>
            <input type="email" id="schoolEmail" class="config-input" placeholder="admin@school.com">
          </div>
          <div class="config-row">
            <div class="config-label">School Phone</div>
            <input type="tel" id="schoolPhone" class="config-input" placeholder="+1-234-567-8900">
          </div>
          <div class="config-row">
            <div class="config-label">Website</div>
            <input type="url" id="schoolWebsite" class="config-input" placeholder="www.yourschool.com">
          </div>
          <div class="config-row">
            <div class="config-label">Address</div>
            <textarea id="schoolAddress" class="config-input config-textarea" placeholder="123 Music Street, Harmony City"></textarea>
          </div>
          <div class="config-row">
            <div class="config-label">Logo URL</div>
            <input type="url" id="schoolLogo" class="config-input" placeholder="https://example.com/logo.png">
          </div>
        </div>
      </div>

      <!-- Business Rules Section -->
      <div id="business" class="config-section">
        <div class="config-group">
          <h3>üí≥ Card & Lesson Settings</h3>
          <div class="config-row">
            <div class="config-label">
              Max Lessons Per Card
              <div class="config-description">Maximum number of lessons allowed per student card</div>
            </div>
            <input type="number" id="maxLessons" class="config-input" min="1" max="50" value="10">
          </div>
          <div class="config-row">
            <div class="config-label">
              Lesson Duration (minutes)
              <div class="config-description">Default duration for each lesson</div>
            </div>
            <input type="number" id="lessonDuration" class="config-input" min="15" max="180" value="60">
          </div>
          <div class="config-row">
            <div class="config-label">
              Card Number Prefix
              <div class="config-description">Prefix for auto-generated card numbers</div>
            </div>
            <input type="text" id="cardPrefix" class="config-input" placeholder="DMS" maxlength="5">
          </div>
          <div class="config-row">
            <div class="config-label">
              Warning Threshold
              <div class="config-description">Show warning when this many lessons remaining</div>
            </div>
            <input type="number" id="warningThreshold" class="config-input" min="1" max="10" value="2">
          </div>
        </div>

        <div class="config-group">
          <h3>üí∞ Fee & Pricing Settings</h3>
          <div class="config-row">
            <div class="config-label">Currency Symbol</div>
            <input type="text" id="currency" class="config-input" placeholder="‚Ç±" maxlength="3">
          </div>
          <div class="config-row">
            <div class="config-label">Default Monthly Fee</div>
            <input type="number" id="defaultFee" class="config-input" min="0" value="2000">
          </div>
          <div class="config-row">
            <div class="config-label">Default Promo Discount (%)</div>
            <input type="number" id="promoDiscount" class="config-input" min="0" max="100" value="15">
          </div>
          <div class="config-row">
            <div class="config-label">Referral Bonus Amount</div>
            <input type="number" id="referralBonus" class="config-input" min="0" value="500">
          </div>
        </div>
      </div>

      <!-- Options & Lists Section -->
      <div id="options" class="config-section">
        <div class="config-group">
          <h3>üë©‚Äçüè´ Teachers</h3>
          <div class="config-row">
            <div class="config-label">
              Available Teachers
              <div class="config-description">Click to add, ‚úï to remove teachers</div>
            </div>
            <div class="tag-input-container" id="teachersContainer">
              <input type="text" class="tag-input" placeholder="Add teacher name..." onkeypress="addTeacher(event)">
            </div>
          </div>
        </div>

        <div class="config-group">
          <h3>üéµ Instruments</h3>
          <div class="config-row">
            <div class="config-label">
              Available Instruments
              <div class="config-description">Musical instruments offered at your school</div>
            </div>
            <div class="tag-input-container" id="instrumentsContainer">
              <input type="text" class="tag-input" placeholder="Add instrument..." onkeypress="addInstrument(event)">
            </div>
          </div>
        </div>

        <div class="config-group">
          <h3>üìä Levels & Categories</h3>
          <div class="config-row">
            <div class="config-label">Skill Levels</div>
            <div class="tag-input-container" id="levelsContainer">
              <input type="text" class="tag-input" placeholder="Add level..." onkeypress="addLevel(event)">
            </div>
          </div>
          <div class="config-row">
            <div class="config-label">Promo Types</div>
            <div class="tag-input-container" id="promosContainer">
              <input type="text" class="tag-input" placeholder="Add promo type..." onkeypress="addPromo(event)">
            </div>
          </div>
        </div>
      </div>

      <!-- Interface & Theme Section -->
      <div id="interface" class="config-section">
        <div class="config-group">
          <h3>üé® Theme & Colors</h3>
          <div class="config-row">
            <div class="config-label">Primary Color</div>
            <input type="color" id="primaryColor" class="config-input" value="#2c3e50">
          </div>
          <div class="config-row">
            <div class="config-label">Secondary Color</div>
            <input type="color" id="secondaryColor" class="config-input" value="#3498db">
          </div>
          <div class="config-row">
            <div class="config-label">Accent Color</div>
            <input type="color" id="accentColor" class="config-input" value="#e74c3c">
          </div>
          <div class="preview-section">
            <h4>Color Preview</h4>
            <div id="colorPreview" class="color-preview">Sample Text with Selected Colors</div>
          </div>
        </div>

        <div class="config-group">
          <h3>üñºÔ∏è Interface Settings</h3>
          <div class="config-row">
            <div class="config-label">Theme Style</div>
            <select id="themeStyle" class="config-input config-select">
              <option value="modern">Modern</option>
              <option value="classic">Classic</option>
              <option value="dark">Dark</option>
            </select>
          </div>
          <div class="config-row">
            <div class="config-label">Card Border Radius</div>
            <input type="range" id="cardRadius" class="config-input" min="0" max="25" value="12">
            <span id="radiusValue">12px</span>
          </div>
          <div class="config-row">
            <div class="config-label">Animation Speed</div>
            <select id="animationSpeed" class="config-input config-select">
              <option value="0.2s">Fast</option>
              <option value="0.3s">Normal</option>
              <option value="0.5s">Slow</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Features & Settings Section -->
      <div id="features" class="config-section">
        <div class="config-group">
          <h3>‚ö° Feature Toggles</h3>
          <div class="config-row">
            <div class="config-label">Enable Advanced Reports</div>
            <input type="checkbox" id="advancedReports" class="config-input">
          </div>
          <div class="config-row">
            <div class="config-label">Enable Bulk Operations</div>
            <input type="checkbox" id="bulkOperations" class="config-input">
          </div>
          <div class="config-row">
            <div class="config-label">Enable Data Export</div>
            <input type="checkbox" id="dataExport" class="config-input">
          </div>
          <div class="config-row">
            <div class="config-label">Enable Referral Tracking</div>
            <input type="checkbox" id="referralTracking" class="config-input">
          </div>
          <div class="config-row">
            <div class="config-label">Enable Teacher Dashboard</div>
            <input type="checkbox" id="teacherDashboard" class="config-input">
          </div>
        </div>

        <div class="config-group">
          <h3>üìÖ Date & Time Settings</h3>
          <div class="config-row">
            <div class="config-label">School Year Start (MM-DD)</div>
            <input type="text" id="schoolYearStart" class="config-input" placeholder="09-01" pattern="\d{2}-\d{2}">
          </div>
          <div class="config-row">
            <div class="config-label">School Year End (MM-DD)</div>
            <input type="text" id="schoolYearEnd" class="config-input" placeholder="06-30" pattern="\d{2}-\d{2}">
          </div>
          <div class="config-row">
            <div class="config-label">Default Report Range (days)</div>
            <input type="number" id="defaultReportRange" class="config-input" min="1" max="365" value="30">
          </div>
        </div>
      </div>

      <!-- Notifications Section -->
      <div id="notifications" class="config-section">
        <div class="config-group">
          <h3>üìß Email Notifications</h3>
          <div class="config-row">
            <div class="config-label">Enable Email Notifications</div>
            <input type="checkbox" id="enableEmail" class="config-input" checked>
          </div>
          <div class="config-row">
            <div class="config-label">Admin Email Addresses</div>
            <div class="tag-input-container" id="adminEmailsContainer">
              <input type="email" class="tag-input" placeholder="Add admin email..." onkeypress="addAdminEmail(event)">
            </div>
          </div>
          <div class="config-row">
            <div class="config-label">Reminder Days Before Expiry</div>
            <input type="number" id="reminderDays" class="config-input" min="1" max="30" value="7">
          </div>
        </div>

        <div class="config-group">
          <h3>üìù Email Templates</h3>
          <div class="config-row">
            <div class="config-label">Welcome Email Template</div>
            <textarea id="welcomeTemplate" class="config-input config-textarea" placeholder="Welcome to our music school!"></textarea>
          </div>
          <div class="config-row">
            <div class="config-label">Reminder Email Template</div>
            <textarea id="reminderTemplate" class="config-input config-textarea" placeholder="Your lessons are about to expire!"></textarea>
          </div>
        </div>
      </div>

      <!-- Advanced Section -->
      <div id="advanced" class="config-section">
        <div class="config-group">
          <h3>üîß Advanced Configuration</h3>
          <div class="config-row">
            <div class="config-label">
              Export Configuration
              <div class="config-description">Download current configuration as JSON file</div>
            </div>
            <button class="action-btn btn-export" onclick="exportConfig()">Download Config</button>
          </div>
          <div class="config-row">
            <div class="config-label">
              Import Configuration
              <div class="config-description">Upload and apply configuration from JSON file</div>
            </div>
            <input type="file" id="configFile" accept=".json" class="config-input">
          </div>
          <div class="config-row">
            <div class="config-label">
              Configuration JSON
              <div class="config-description">Direct JSON editing for advanced users</div>
            </div>
            <textarea id="configJson" class="config-input config-textarea" style="min-height: 200px; font-family: monospace;"></textarea>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="action-btn btn-save" onclick="saveConfiguration()">üíæ Save Changes</button>
        <button class="action-btn btn-validate" onclick="validateConfiguration()">‚úÖ Validate Config</button>
        <button class="action-btn btn-export" onclick="previewChanges()">üëÅÔ∏è Preview</button>
        <button class="action-btn btn-reset" onclick="resetConfiguration()">üîÑ Reset to Defaults</button>
      </div>
    </div>
  </div>

  <script>
    // Robust navigation function with multiple backend method support
    function goToPage(page) {
      console.log('Navigating to:', page);
      
      try {
        // Method 1: Try include function (if available)
        if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.include) {
          console.log('Using include method for navigation');
          google.script.run
            .withSuccessHandler(function(html) {
              console.log('Include method successful');
              document.documentElement.innerHTML = html;
            })
            .withFailureHandler(function(error) {
              console.log('Include method failed:', error);
              // Fallback to Method 2
              tryLoadHtmlMethod(page);
            })
            .include(page);
          return;
        }
        
        // Method 2: Try loadHtml function (if available)
        if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.loadHtml) {
          console.log('Using loadHtml method for navigation');
          tryLoadHtmlMethod(page);
          return;
        }
        
        // Method 3: Direct window location (fallback)
        console.log('Using window.location fallback for navigation');
        window.location.href = page;
        
      } catch (error) {
        console.error('Navigation error:', error);
        // Final fallback
        window.location.href = page;
      }
    }
    
    function tryLoadHtmlMethod(page) {
      google.script.run
        .withSuccessHandler(function(html) {
          console.log('LoadHtml method successful');
          document.documentElement.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          console.log('LoadHtml method failed:', error);
          console.log('Using window.location as final fallback');
          window.location.href = page;
        })
        .loadHtml(page);
    }

    // Configuration data storage
    let currentConfig = {};

    // Initialize page
    window.addEventListener('DOMContentLoaded', function() {
      loadConfiguration();
      setupEventListeners();
    });

    function showSection(sectionId) {
      // Hide all sections
      document.querySelectorAll('.config-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active class from tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(sectionId).classList.add('active');
      event.target.classList.add('active');
    }

    function loadConfiguration() {
      showStatus('Loading configuration...', 'warning');
      
      google.script.run.withSuccessHandler(function(config) {
        currentConfig = config || {};
        populateForm(currentConfig);
        showStatus('Configuration loaded successfully!', 'success');
      }).withFailureHandler(function(error) {
        showStatus('Error loading configuration: ' + error.message, 'error');
      }).exportConfiguration();
    }

    function populateForm(config) {
      try {
        const configObj = typeof config === 'string' ? JSON.parse(config) : config;
        
        // School info
        document.getElementById('schoolName').value = configObj.SCHOOL?.name || '';
        document.getElementById('schoolEmail').value = configObj.SCHOOL?.email || '';
        document.getElementById('schoolPhone').value = configObj.SCHOOL?.phone || '';
        document.getElementById('schoolWebsite').value = configObj.SCHOOL?.website || '';
        document.getElementById('schoolAddress').value = configObj.SCHOOL?.address || '';
        document.getElementById('schoolLogo').value = configObj.SCHOOL?.logo || '';

        // Business rules
        document.getElementById('maxLessons').value = configObj.CARDS?.maxLessonsPerCard || 10;
        document.getElementById('lessonDuration').value = configObj.CARDS?.defaultLessonDuration || 60;
        document.getElementById('cardPrefix').value = configObj.CARDS?.cardNumberPrefix || 'DMS';
        document.getElementById('warningThreshold').value = configObj.CARDS?.warningLessonsLeft || 2;
        document.getElementById('currency').value = configObj.FEES?.currency || '‚Ç±';
        document.getElementById('defaultFee').value = configObj.FEES?.defaultMonthlyFee || 2000;
        document.getElementById('promoDiscount').value = configObj.FEES?.promoDiscountPercent || 15;
        document.getElementById('referralBonus').value = configObj.FEES?.referralBonus || 500;

        // Interface
        document.getElementById('primaryColor').value = configObj.INTERFACE?.primaryColor || '#2c3e50';
        document.getElementById('secondaryColor').value = configObj.INTERFACE?.secondaryColor || '#3498db';
        document.getElementById('accentColor').value = configObj.INTERFACE?.accentColor || '#e74c3c';
        document.getElementById('themeStyle').value = configObj.INTERFACE?.theme || 'modern';
        document.getElementById('cardRadius').value = parseInt(configObj.INTERFACE?.cardRadius) || 12;
        document.getElementById('animationSpeed').value = configObj.INTERFACE?.animationSpeed || '0.3s';

        // Features
        document.getElementById('advancedReports').checked = configObj.FEATURES?.enableAdvancedReports !== false;
        document.getElementById('bulkOperations').checked = configObj.FEATURES?.enableBulkOperations !== false;
        document.getElementById('dataExport').checked = configObj.FEATURES?.enableDataExport !== false;
        document.getElementById('referralTracking').checked = configObj.FEATURES?.enableReferralTracking !== false;
        document.getElementById('teacherDashboard').checked = configObj.FEATURES?.enableTeacherDashboard !== false;

        // Dates
        document.getElementById('schoolYearStart').value = configObj.DATES?.schoolYearStart || '09-01';
        document.getElementById('schoolYearEnd').value = configObj.DATES?.schoolYearEnd || '06-30';
        document.getElementById('defaultReportRange').value = configObj.DATES?.defaultReportRange || 30;

        // Notifications
        document.getElementById('enableEmail').checked = configObj.NOTIFICATIONS?.enableEmail !== false;
        document.getElementById('reminderDays').value = configObj.NOTIFICATIONS?.reminderDaysBeforeExpiry || 7;
        document.getElementById('welcomeTemplate').value = configObj.NOTIFICATIONS?.welcomeEmailTemplate || '';
        document.getElementById('reminderTemplate').value = configObj.NOTIFICATIONS?.reminderEmailTemplate || '';

        // Populate tag inputs
        populateTagInput('teachersContainer', configObj.OPTIONS?.teachers || []);
        populateTagInput('instrumentsContainer', configObj.OPTIONS?.instruments || []);
        populateTagInput('levelsContainer', configObj.OPTIONS?.levels || []);
        populateTagInput('promosContainer', configObj.OPTIONS?.promoTypes || []);
        populateTagInput('adminEmailsContainer', configObj.NOTIFICATIONS?.adminEmails || []);

        // JSON editor
        document.getElementById('configJson').value = JSON.stringify(configObj, null, 2);

        updateColorPreview();
        updateRadiusValue();

      } catch (error) {
        showStatus('Error parsing configuration: ' + error.message, 'error');
      }
    }

    function populateTagInput(containerId, items) {
      const container = document.getElementById(containerId);
      const input = container.querySelector('.tag-input');
      
      // Clear existing tags
      container.querySelectorAll('.tag').forEach(tag => tag.remove());
      
      // Add items as tags
      items.forEach(item => {
        if (item && item.trim()) {
          addTag(container, item.trim(), input);
        }
      });
    }

    function addTag(container, text, input) {
      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.innerHTML = `
        ${text}
        <button class="tag-remove" onclick="removeTag(this)">√ó</button>
      `;
      container.insertBefore(tag, input);
    }

    function removeTag(button) {
      button.parentElement.remove();
    }

    function addTeacher(event) {
      if (event.key === 'Enter') {
        const input = event.target;
        const text = input.value.trim();
        if (text) {
          addTag(input.parentElement, text, input);
          input.value = '';
        }
      }
    }

    function addInstrument(event) {
      if (event.key === 'Enter') {
        const input = event.target;
        const text = input.value.trim();
        if (text) {
          addTag(input.parentElement, text, input);
          input.value = '';
        }
      }
    }

    function addLevel(event) {
      if (event.key === 'Enter') {
        const input = event.target;
        const text = input.value.trim();
        if (text) {
          addTag(input.parentElement, text, input);
          input.value = '';
        }
      }
    }

    function addPromo(event) {
      if (event.key === 'Enter') {
        const input = event.target;
        const text = input.value.trim();
        if (text) {
          addTag(input.parentElement, text, input);
          input.value = '';
        }
      }
    }

    function addAdminEmail(event) {
      if (event.key === 'Enter') {
        const input = event.target;
        const email = input.value.trim();
        if (email && email.includes('@')) {
          addTag(input.parentElement, email, input);
          input.value = '';
        }
      }
    }

    function getTagValues(containerId) {
      const container = document.getElementById(containerId);
      const tags = container.querySelectorAll('.tag');
      return Array.from(tags).map(tag => tag.textContent.replace('√ó', '').trim());
    }

    function setupEventListeners() {
      // Color preview updates
      ['primaryColor', 'secondaryColor', 'accentColor'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateColorPreview);
      });

      // Radius slider update
      document.getElementById('cardRadius').addEventListener('input', updateRadiusValue);

      // File import
      document.getElementById('configFile').addEventListener('change', handleFileImport);
    }

    function updateColorPreview() {
      const primary = document.getElementById('primaryColor').value;
      const secondary = document.getElementById('secondaryColor').value;
      const accent = document.getElementById('accentColor').value;
      
      const preview = document.getElementById('colorPreview');
      preview.style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 50%, ${accent} 100%)`;
    }

    function updateRadiusValue() {
      const value = document.getElementById('cardRadius').value;
      document.getElementById('radiusValue').textContent = value + 'px';
    }

    function saveConfiguration() {
      showStatus('Saving configuration...', 'warning');

      const newConfig = {
        SCHOOL: {
          name: document.getElementById('schoolName').value,
          email: document.getElementById('schoolEmail').value,
          phone: document.getElementById('schoolPhone').value,
          website: document.getElementById('schoolWebsite').value,
          address: document.getElementById('schoolAddress').value,
          logo: document.getElementById('schoolLogo').value
        },
        CARDS: {
          maxLessonsPerCard: parseInt(document.getElementById('maxLessons').value),
          defaultLessonDuration: parseInt(document.getElementById('lessonDuration').value),
          cardNumberPrefix: document.getElementById('cardPrefix').value,
          warningLessonsLeft: parseInt(document.getElementById('warningThreshold').value)
        },
        FEES: {
          currency: document.getElementById('currency').value,
          defaultMonthlyFee: parseInt(document.getElementById('defaultFee').value),
          promoDiscountPercent: parseInt(document.getElementById('promoDiscount').value),
          referralBonus: parseInt(document.getElementById('referralBonus').value)
        },
        OPTIONS: {
          teachers: getTagValues('teachersContainer'),
          instruments: getTagValues('instrumentsContainer'),
          levels: getTagValues('levelsContainer'),
          promoTypes: getTagValues('promosContainer')
        },
        INTERFACE: {
          theme: document.getElementById('themeStyle').value,
          primaryColor: document.getElementById('primaryColor').value,
          secondaryColor: document.getElementById('secondaryColor').value,
          accentColor: document.getElementById('accentColor').value,
          cardRadius: document.getElementById('cardRadius').value + 'px',
          animationSpeed: document.getElementById('animationSpeed').value
        },
        FEATURES: {
          enableAdvancedReports: document.getElementById('advancedReports').checked,
          enableBulkOperations: document.getElementById('bulkOperations').checked,
          enableDataExport: document.getElementById('dataExport').checked,
          enableReferralTracking: document.getElementById('referralTracking').checked,
          enableTeacherDashboard: document.getElementById('teacherDashboard').checked
        },
        DATES: {
          schoolYearStart: document.getElementById('schoolYearStart').value,
          schoolYearEnd: document.getElementById('schoolYearEnd').value,
          defaultReportRange: parseInt(document.getElementById('defaultReportRange').value)
        },
        NOTIFICATIONS: {
          enableEmail: document.getElementById('enableEmail').checked,
          reminderDaysBeforeExpiry: parseInt(document.getElementById('reminderDays').value),
          adminEmails: getTagValues('adminEmailsContainer'),
          welcomeEmailTemplate: document.getElementById('welcomeTemplate').value,
          reminderEmailTemplate: document.getElementById('reminderTemplate').value
        }
      };

      google.script.run.withSuccessHandler(function(result) {
        if (result) {
          showStatus('Configuration saved successfully!', 'success');
        } else {
          showStatus('Failed to save configuration', 'error');
        }
      }).withFailureHandler(function(error) {
        showStatus('Error saving configuration: ' + error.message, 'error');
      }).importConfiguration(JSON.stringify(newConfig));
    }

    function validateConfiguration() {
      showStatus('Validating configuration...', 'warning');
      
      google.script.run.withSuccessHandler(function(result) {
        if (result.valid) {
          showStatus(result.summary, 'success');
        } else {
          showStatus(result.summary + ': ' + result.issues.join(', '), 'error');
        }
      }).withFailureHandler(function(error) {
        showStatus('Validation error: ' + error.message, 'error');
      }).validateConfiguration();
    }

    function exportConfig() {
      google.script.run.withSuccessHandler(function(configJson) {
        const blob = new Blob([configJson], {type: 'application/json'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dms-config-' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
        window.URL.revokeObjectURL(url);
        showStatus('Configuration exported successfully!', 'success');
      }).withFailureHandler(function(error) {
        showStatus('Export error: ' + error.message, 'error');
      }).exportConfiguration();
    }

    function handleFileImport(event) {
      const file = event.target.files[0];
      if (file && file.type === 'application/json') {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const config = JSON.parse(e.target.result);
            populateForm(config);
            showStatus('Configuration imported from file!', 'success');
          } catch (error) {
            showStatus('Invalid JSON file: ' + error.message, 'error');
          }
        };
        reader.readAsText(file);
      }
    }

    function previewChanges() {
      // Create a preview popup or modal
      showStatus('Preview functionality - check your forms with current settings!', 'success');
    }

    function resetConfiguration() {
      if (confirm('Are you sure you want to reset all configuration to defaults? This cannot be undone.')) {
        google.script.run.withSuccessHandler(function(result) {
          if (result) {
            loadConfiguration();
            showStatus('Configuration reset to defaults!', 'success');
          } else {
            showStatus('Failed to reset configuration', 'error');
          }
        }).withFailureHandler(function(error) {
          showStatus('Reset error: ' + error.message, 'error');
        }).resetConfiguration();
      }
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = `status-message status-${type}`;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }
  </script>
</body>
</html>
